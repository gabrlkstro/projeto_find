{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'mainpage/css/chat_detail.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css">

<div class="container py-4 chat-shell">

  <div class="card chat-card">
    <!-- HEADER -->
    <div class="chat-header d-flex align-items-center justify-content-between gap-3">
      <div class="d-flex align-items-center gap-3">
        <div class="rounded-circle d-flex align-items-center justify-content-center"
             style="width:44px;height:44px;background:rgba(13,110,253,.12);">
          <i class="bi bi-chat-dots"></i>
        </div>

        <div>
          <p class="chat-title">
            {% if chat.item %}{{ chat.item.titulo }}{% else %}Item removido{% endif %}
          </p>
          <div class="chat-sub text-muted">
            {% if request.user.id == chat.dono_item_id %}
              Interessado: <b>{{ chat.criado_por.username }}</b>
            {% else %}
              Dono: <b>{{ chat.dono_item.username }}</b>
            {% endif %}
            <span class="mx-2">â€¢</span>
            <span>Status: <b id="statusText">{{ chat.get_status_display }}</b></span>
          </div>
        </div>
      </div>

      <a href="{% url 'chats_list' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
    </div>

    <!-- BODY -->
    <div class="card-body chat-body" id="messagesBox">
      <div id="messages"></div>
    </div>

    <!-- FOOTER -->
    <div class="chat-footer">
      <form id="msgForm">
        {% csrf_token %}
        <div class="d-flex gap-2">
          <input class="form-control chat-input" name="conteudo" id="conteudo"
                 placeholder="Digite sua mensagem..." autocomplete="off" />
          <button class="btn btn-primary send-btn" type="submit">
            <i class="bi bi-send"></i> Enviar
          </button>
        </div>
        <small class="text-danger d-none" id="err"></small>
        <div class="typing-hint text-muted">
          Dica: use mensagens curtas e objetivas ðŸ™‚
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const urlList = "{% url 'chat_messages' chat.id %}";
  const urlSend = "{% url 'chat_send_message' chat.id %}";
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  const messagesEl = document.getElementById("messages");
  const box = document.getElementById("messagesBox");
  const err = document.getElementById("err");
  const statusText = document.getElementById("statusText");

  function showError(msg){
    err.textContent = msg;
    err.classList.remove("d-none");
    setTimeout(()=>err.classList.add("d-none"), 2500);
  }

  function escapeHtml(text){
    const div = document.createElement("div");
    div.innerText = text;
    return div.innerHTML;
  }

  function isNearBottom(){
    return (box.scrollHeight - box.scrollTop - box.clientHeight) < 140;
  }

  function renderMessages(mensagens){
    const shouldStick = isNearBottom();
    messagesEl.innerHTML = "";

    for (const m of mensagens){
      const wrap = document.createElement("div");
      wrap.className = "msg " + (m.is_me ? "me" : "other");

      wrap.innerHTML = `
        <div class="bubble">
          <div class="meta">
            <span class="name">${m.is_me ? "VocÃª" : escapeHtml(m.remetente)}</span>
            <span class="time">${escapeHtml(m.data_envio)}</span>
          </div>
          <div class="text">${escapeHtml(m.conteudo)}</div>
        </div>
      `;
      messagesEl.appendChild(wrap);
    }

    if (shouldStick) box.scrollTop = box.scrollHeight;
  }

  async function loadMessages(){
    const r = await fetch(urlList);
    const data = await r.json();
    if(!r.ok){ showError(data.error || "Erro ao carregar"); return; }

    // se vocÃª retornar status no JSON, dÃ¡ pra refletir aqui:
    if (data.status) statusText.textContent = data.status === "ativo" ? "Ativo" : "Fechado";

    renderMessages(data.mensagens || []);
  }

  document.getElementById("msgForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const input = document.getElementById("conteudo");
    const conteudo = input.value.trim();
    if(!conteudo) return;

    const body = new URLSearchParams();
    body.append("conteudo", conteudo);

    const r = await fetch(urlSend, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": csrfToken
      },
      body: body.toString()
    });

    const data = await r.json();
    if(!r.ok){ showError(data.error || "Erro ao enviar"); return; }

    input.value = "";
    await loadMessages();
  });

  // Start
  loadMessages();
  setInterval(loadMessages, 2000);
</script>
{% endblock %}
