{% extends 'base.html' %}
{% load static %}

{% block title %}Perfil do UsuÃ¡rio{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'mainpage/css/user.css' %}">

<div class="container py-5">

    <!-- LINHA 1: PERFIL + ITENS -->
    <div class="row g-4 align-items-stretch">

        <!-- PERFIL -->
        <div class="col-lg-4 col-md-5">
            <div class="card shadow-sm text-center p-4 user-card border-0 h-100">

                <div class="avatar mx-auto mb-3 position-relative">
                    <img
                        src="{% if user.profile.image %}{{ user.profile.image.url }}{% else %}{% static 'mainpage/img/user.png' %}{% endif %}"
                        class="profile-pic"
                        alt="Foto de perfil"
                    >

                    <form action="{% url 'upload_photo' %}" method="POST" enctype="multipart/form-data" id="form-foto">
                        {% csrf_token %}
                        <label for="input-foto" class="upload-badge shadow">
                            <i class="bi bi-camera-fill"></i>
                        </label>
                        <input
                            type="file"
                            name="image"
                            id="input-foto"
                            hidden
                            onchange="document.getElementById('form-foto').submit();"
                        >
                    </form>
                </div>

                <h4 class="fw-bold mb-0">{{ nome }}</h4>
                <p class="text-muted small mb-2">{{ email }}</p>

                <div class="row small text-start g-1 mt-3 px-3">
                    <div class="col-5 text-muted">Telefone:</div>
                    <div class="col-7">{{ user.profile.telefone|default:"---" }}</div>

                    <div class="col-5 text-muted">CEP:</div>
                    <div class="col-7">{{ user.profile.cep|default:"---" }}</div>

                    <div class="col-5 text-muted">LocalizaÃ§Ã£o:</div>
                    <div class="col-7">
                        {% if user.profile.cidade %}
                            {{ user.profile.cidade }} - {{ user.profile.estado }}
                        {% else %}
                            <span class="text-muted fst-italic">NÃ£o informada</span>
                        {% endif %}
                    </div>
                </div>

                <button
                    class="btn btn-primary w-100 rounded-pill mt-4"
                    data-bs-toggle="modal"
                    data-bs-target="#modalEditarPerfil"
                    type="button"
                >
                    <i class="bi bi-pencil-square me-2"></i> Editar perfil
                </button>

            </div>
        </div>

        <!-- ITENS -->
        <div class="col-lg-8 col-md-7">
            <div class="card shadow-sm items-card border-0 h-100">

                <div class="card-header d-flex justify-content-between align-items-center border-0 py-3">
                    <h5 class="fw-bold mb-0 text-white">Meus itens</h5>

                    <button
                        class="btn btn-light btn-sm rounded-pill"
                        data-bs-toggle="modal"
                        data-bs-target="#modalNovoItem"
                        type="button"
                    >
                        <i class="bi bi-plus-lg"></i> Novo item
                    </button>
                </div>

                <div class="card-body">
                    {% if itens %}
                        <div class="d-flex flex-column gap-3">
                            {% for item in itens|slice:":3" %}
                                <div class="item-lista-horizontal shadow-sm">

                                    <!-- FOTO -->
                                    <div class="item-col-img">
                                        <div class="item-img-container">
                                            <img
                                                src="{% if item.imagem %}{{ item.imagem.url }}{% else %}{% static 'mainpage/img/item-default.png' %}{% endif %}"
                                                alt="{{ item.titulo }}"
                                            >
                                        </div>
                                    </div>

                                    <!-- INFO -->
                                    <div class="item-col-info">
                                        <h6 class="fw-bold mb-0 text-truncate">{{ item.titulo }}</h6>
                                        <p class="text-muted small mb-1">{{ item.categoria }}</p>
                                        <small class="text-muted d-block">
                                            <i class="bi bi-geo-alt"></i> {{ item.local|default:"---" }}
                                        </small>
                                    </div>

                                    <!-- AÃ‡Ã•ES -->
                                    <div class="item-col-actions">
                                        <a href="{% url 'item_detail' item.slug %}" class="btn btn-dark btn-ver-lista">
                                            VER ITEM
                                        </a>

                                        <div class="item-actions-row">
                                            <a href="{% url 'item_edit' item.id %}"
                                               class="btn btn-sm btn-outline-primary rounded-pill"
                                               title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </a>

                                            <button class="btn btn-sm btn-outline-danger rounded-pill"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalDeletarItem{{ item.id }}"
                                                    type="button"
                                                    title="Excluir">
                                                <i class="bi bi-trash"></i>
                                            </button>

                                            {% if item.status == 'perdido' %}
                                                <span class="status-badge-horizontal status-perdido" title="Perdido">
                                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                                </span>
                                            {% else %}
                                                <span class="status-badge-horizontal status-achado" title="Achado">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>

                                </div>
                            {% endfor %}
                        </div>

                        {% if itens|length > 3 %}
                            <div class="text-center mt-4">
                                <a href="{% url 'item_list' %}" class="btn-ver-todos-custom">
                                    VER TODOS ({{ itens|length }})
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <p class="text-center text-muted mb-0">Nenhum item cadastrado.</p>
                    {% endif %}
                </div>

            </div>
        </div>

    </div>

    <!-- LINHA 2: ESTATÃSTICAS (CORRIGIDO) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card stats-card shadow-sm border-0 p-4">
                <h6 class="fw-bold mb-3">ðŸ“Š EstatÃ­sticas</h6>

                <div class="row g-3 text-center">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <h3 class="fw-bold mb-0">{{ total }}</h3>
                            <small>TOTAL</small>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="stat-card">
                            <h3 class="fw-bold mb-0">{{ perdidos }}</h3>
                            <small>PERDIDOS</small>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="stat-card">
                            <h3 class="fw-bold mb-0">{{ encontrados }}</h3>
                            <small>ENCONTRADOS</small>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

<!-- MODAIS DE EXCLUSÃƒO -->
{% for item in itens %}
<div class="modal fade" id="modalDeletarItem{{ item.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius:20px; overflow:hidden;">

      <form method="POST" action="{% url 'item_delete' item.id %}">
        {% csrf_token %}

        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Excluir Item</h5>

          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close">
          </button>
        </div>

        <div class="modal-body text-center">
          Tem certeza que deseja excluir <strong>{{ item.titulo }}</strong>?
        </div>

        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">
            Cancelar
          </button>

          <button type="submit" class="btn btn-danger">
            Excluir
          </button>
        </div>

      </form>

    </div>
  </div>
</div>
{% endfor %}


{% endblock %}
